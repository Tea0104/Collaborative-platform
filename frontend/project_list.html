<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>多角色共创平台 - 项目列表</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: "Segoe UI", "Microsoft YaHei", sans-serif; }
        body { background-color: #f5f7fa; color: #333; line-height: 1.6; }
        .container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }

        header {
            background: linear-gradient(135deg, #2c7be5 0%, #1c5bb8 100%);
            color: white;
            padding: 15px 0;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo h1 {
            font-size: 24px;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
        }

        .btn-secondary {
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
        }

        .btn-secondary:hover { background-color: rgba(255, 255, 255, 0.3); }

        nav {
            background-color: white;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        .nav-container { display: flex; gap: 30px; }

        .nav-link {
            padding: 15px 0;
            color: #666;
            font-weight: 500;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 8px;
            position: relative;
        }

        .nav-link.active { color: #2c7be5; }

        .nav-link.active::after {
            content: "";
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 3px;
            background-color: #2c7be5;
            border-radius: 3px 3px 0 0;
        }

        .filters-section {
            background-color: white;
            padding: 25px;
            margin: 20px 0;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        .section-title {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 20px;
            color: #2c7be5;
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .filter-group { display: flex; flex-direction: column; gap: 8px; }
        .filter-label { font-size: 14px; color: #666; font-weight: 500; }

        .filter-input, .filter-select {
            padding: 10px 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.2s;
        }

        .filter-input:focus, .filter-select:focus {
            outline: none;
            border-color: #2c7be5;
            box-shadow: 0 0 0 3px rgba(44, 123, 229, 0.1);
        }

        .filter-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 10px;
        }

        .btn-primary {
            background-color: #2c7be5;
            color: white;
            transition: background-color 0.2s;
        }

        .btn-primary:hover { background-color: #1c5bb8; }

        .projects-section { margin-bottom: 40px; }

        .projects-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .projects-count { color: #666; font-size: 14px; }

        .projects-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 25px;
        }

        .project-card {
            background-color: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .project-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.12);
        }

        .project-header {
            padding: 20px;
            border-bottom: 1px solid #eee;
        }

        .project-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
            color: #222;
        }

        .project-org { color: #666; font-size: 14px; margin-bottom: 10px; }

        .project-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .tag {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }

        .tag-status { background-color: #e1f0ff; color: #2c7be5; }

        .project-body { padding: 20px; }

        .project-description {
            color: #555;
            font-size: 14px;
            line-height: 1.6;
            margin-bottom: 20px;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
            min-height: 66px;
        }

        .project-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }

        .detail-item { display: flex; flex-direction: column; gap: 4px; }
        .detail-label { font-size: 12px; color: #888; }
        .detail-value { font-size: 14px; font-weight: 500; color: #333; }

        .project-footer { padding: 0 20px 20px; }

        .btn-detail {
            display: block;
            width: 100%;
            text-align: center;
            background-color: #2c7be5;
            color: white;
            padding: 12px;
            border-radius: 6px;
            text-decoration: none;
            font-weight: 500;
            transition: background-color 0.2s;
        }

        .btn-detail:hover { background-color: #1c5bb8; }

        .empty, .error {
            background: #fff;
            border-radius: 10px;
            padding: 30px;
            text-align: center;
            color: #666;
        }

        .error { color: #b00020; }

        footer {
            background-color: #222;
            color: #aaa;
            padding: 40px 0 20px;
            margin-top: 60px;
        }

        .footer-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 40px;
            margin-bottom: 30px;
        }

        .footer-section h3 {
            color: white;
            font-size: 18px;
            margin-bottom: 20px;
        }

        .footer-links { list-style: none; }
        .footer-links li { margin-bottom: 10px; }

        .footer-links a {
            color: #aaa;
            text-decoration: none;
            transition: color 0.2s;
        }

        .footer-links a:hover { color: white; }

        .copyright {
            text-align: center;
            padding-top: 20px;
            border-top: 1px solid #444;
            font-size: 14px;
            color: #888;
        }

        @media (max-width: 768px) {
            .projects-grid { grid-template-columns: 1fr; }
            .filters-grid { grid-template-columns: 1fr; }
            .header-container { flex-direction: column; gap: 15px; }
            .projects-header { flex-direction: column; align-items: flex-start; gap: 10px; }
        }
    </style>
</head>
<body>
<header>
    <div class="container header-container">
        <div class="logo">
            <h1><i class="fas fa-users-cog"></i> 多角色共创平台</h1>
        </div>
        <div class="user-info">
            <span id="current-user"><i class="fas fa-user"></i> 未登录</span>
            <button class="btn btn-secondary" onclick="logout()">退出登录</button>
        </div>
    </div>
</header>

<nav>
    <div class="container nav-container">
        <a href="project_list.html" class="nav-link active"><i class="fas fa-project-diagram"></i> 项目列表</a>
        <a href="#" class="nav-link" id="nav-action-link"><i class="fas fa-briefcase"></i> 我的申请</a>
        <a href="#" class="nav-link"><i class="fas fa-history"></i> 参与记录</a>
        <a href="#" class="nav-link"><i class="fas fa-user-circle"></i> 个人中心</a>
    </div>
</nav>

<main class="container">
    <section class="filters-section">
        <div class="section-title">
            <i class="fas fa-filter"></i>
            <h2>项目筛选</h2>
        </div>

        <div class="filters-grid">
            <div class="filter-group">
                <label class="filter-label">关键词搜索</label>
                <input type="text" class="filter-input" id="keyword" placeholder="项目名称、描述、公司">
            </div>

            <div class="filter-group">
                <label class="filter-label">项目状态</label>
                <select class="filter-select" id="status">
                    <option value="">全部状态</option>
                    <option value="招募中">招募中</option>
                    <option value="进行中">进行中</option>
                    <option value="已完成">已完成</option>
                    <option value="已终止">已终止</option>
                </select>
            </div>

            <div class="filter-group">
                <label class="filter-label">项目类型（占位）</label>
                <select class="filter-select" id="type">
                    <option value="">全部类型</option>
                    <option value="tech">技术开发</option>
                    <option value="design">方案设计</option>
                    <option value="research">调研分析</option>
                    <option value="public">公益项目</option>
                </select>
            </div>

            <div class="filter-group">
                <label class="filter-label">难度等级（占位）</label>
                <select class="filter-select" id="difficulty">
                    <option value="">全部难度</option>
                    <option value="beginner">入门级</option>
                    <option value="intermediate">进阶级</option>
                    <option value="advanced">专家级</option>
                </select>
            </div>

            <div class="filter-group">
                <label class="filter-label">合作模式（占位）</label>
                <select class="filter-select" id="mode">
                    <option value="">全部模式</option>
                    <option value="paid">付费项目</option>
                    <option value="exchange">资源置换</option>
                    <option value="volunteer">公益志愿</option>
                </select>
            </div>

            <div class="filter-group">
                <label class="filter-label">排序方式</label>
                <select class="filter-select" id="sort">
                    <option value="newest">最新发布</option>
                    <option value="deadline">截止时间</option>
                </select>
            </div>
        </div>

        <div class="filter-actions">
            <button class="btn btn-secondary" onclick="clearFilters()"><i class="fas fa-eraser"></i> 清空条件</button>
            <button class="btn btn-primary" onclick="searchProjects()"><i class="fas fa-search"></i> 搜索项目</button>
        </div>
    </section>

    <section class="projects-section">
        <div class="projects-header">
            <div class="section-title">
                <i class="fas fa-list-ul"></i>
                <h2>可申请项目</h2>
            </div>
            <div class="projects-count">共 <span id="total-projects">0</span> 个项目</div>
        </div>
        <div class="projects-grid" id="projects-container"></div>
    </section>

    <section class="projects-section" id="my-apps-section" style="display: none;">
        <div class="projects-header">
            <div class="section-title">
                <i class="fas fa-briefcase"></i>
                <h2>我的申请</h2>
            </div>
        </div>
        <div class="projects-grid" id="my-apps-container"></div>
    </section>
</main>

<footer>
    <div class="container footer-container">
        <div class="footer-section">
            <h3>平台服务</h3>
            <ul class="footer-links">
                <li><a href="#"><i class="fas fa-info-circle"></i> 平台介绍</a></li>
                <li><a href="#"><i class="fas fa-question-circle"></i> 使用指南</a></li>
                <li><a href="#"><i class="fas fa-graduation-cap"></i> 技能培训</a></li>
            </ul>
        </div>
        <div class="footer-section">
            <h3>项目相关</h3>
            <ul class="footer-links">
                <li><a href="#"><i class="fas fa-book"></i> 项目规范</a></li>
                <li><a href="#"><i class="fas fa-certificate"></i> 成果认证</a></li>
                <li><a href="#"><i class="fas fa-exchange-alt"></i> 成果转化</a></li>
            </ul>
        </div>
        <div class="footer-section">
            <h3>联系我们</h3>
            <ul class="footer-links">
                <li><a href="#"><i class="fas fa-envelope"></i> 合作邮箱</a></li>
                <li><a href="#"><i class="fab fa-weixin"></i> 微信公众号</a></li>
                <li><a href="#"><i class="fas fa-phone"></i> 客服热线</a></li>
            </ul>
        </div>
    </div>
    <div class="copyright">
        <p>© 2026 多角色共创平台 保留所有权利</p>
        <p style="margin-top: 8px; font-size: 12px;">能力成长 + 可验证成果 = 职业竞争力</p>
    </div>
</footer>

<script>
    const API_BASE = localStorage.getItem("api_base") || "http://127.0.0.1:5000";
    const token = localStorage.getItem("auth_token") || localStorage.getItem("token") || "";

    function normalizeText(v) {
        return String(v || "").trim();
    }

    function formatDate(value) {
        if (!value) return "未设置";
        const str = String(value);
        const d = new Date(str.replace(" ", "T"));
        if (Number.isNaN(d.getTime())) return str;
        return d.toLocaleString("zh-CN", { hour12: false });
    }

    function escapeHtml(value) {
        return String(value || "")
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/\"/g, "&quot;")
            .replace(/'/g, "&#39;");
    }

    function setCurrentUserDisplay(username, userType) {
        const userText = username && userType ? `${username} (${userType})` : "未登录";
        document.getElementById("current-user").innerHTML = `<i class="fas fa-user"></i> ${escapeHtml(userText)}`;
    }

    function isStudentUser() {
        const t = (localStorage.getItem("user_type") || "").trim();
        return ["学生", "student", "Student"].includes(t);
    }

    function isEnterpriseUser() {
        const t = (localStorage.getItem("user_type") || "").trim();
        return ["企业", "enterprise", "Enterprise"].includes(t);
    }

    function updateNavActionLink() {
        const link = document.getElementById("nav-action-link");
        if (isEnterpriseUser()) {
            link.href = "enterprise_center.html";
            link.innerHTML = `<i class="fas fa-building"></i> 企业中心`;
            return;
        }
        link.href = "my_applications.html";
        link.innerHTML = `<i class="fas fa-briefcase"></i> 我的申请`;
    }

    async function logout() {
        const authToken = localStorage.getItem("auth_token") || localStorage.getItem("token") || "";
        if (authToken) {
            try {
                await fetch(`${API_BASE}/api/auth/logout`, {
                    method: "POST",
                    headers: { Authorization: `Bearer ${authToken}` }
                });
            } catch (_) {
            }
        }

        localStorage.removeItem("auth_token");
        localStorage.removeItem("token");
        localStorage.removeItem("username");
        localStorage.removeItem("user_type");
        localStorage.removeItem("user");
        window.location.href = "login.html";
    }

    function applyFilters(projects) {
        const keyword = normalizeText(document.getElementById("keyword").value).toLowerCase();
        const status = normalizeText(document.getElementById("status").value);
        const sort = normalizeText(document.getElementById("sort").value) || "newest";

        let result = projects.filter((project) => {
            if (keyword) {
                const haystack = [project.project_name, project.description, project.company]
                    .map(normalizeText)
                    .join(" ")
                    .toLowerCase();
                if (!haystack.includes(keyword)) return false;
            }
            if (status && normalizeText(project.project_status) !== status) {
                return false;
            }
            return true;
        });

        if (sort === "deadline") {
            result = result.slice().sort((a, b) => {
                const ad = new Date((a.deadline || "").replace(" ", "T")).getTime() || Number.MAX_SAFE_INTEGER;
                const bd = new Date((b.deadline || "").replace(" ", "T")).getTime() || Number.MAX_SAFE_INTEGER;
                return ad - bd;
            });
        } else {
            result = result.slice().sort((a, b) => {
                const at = new Date((a.publish_time || "").replace(" ", "T")).getTime() || 0;
                const bt = new Date((b.publish_time || "").replace(" ", "T")).getTime() || 0;
                return bt - at;
            });
        }

        return result;
    }

    function renderProjects(projects) {
        const container = document.getElementById("projects-container");
        document.getElementById("total-projects").textContent = String(projects.length);

        if (!projects.length) {
            container.innerHTML = '<div class="empty">暂无符合条件的项目</div>';
            return;
        }

        container.innerHTML = projects.map((project) => {
            const projectName = escapeHtml(project.project_name || "-");
            const company = escapeHtml(project.company || "-");
            const description = escapeHtml(project.description || "暂无描述");
            const status = escapeHtml(project.project_status || "-");
            const publishTime = escapeHtml(formatDate(project.publish_time));
            const deadline = escapeHtml(formatDate(project.deadline));
            const expectedMarket = escapeHtml(project.expected_market || "未设置");
            const workMode = escapeHtml(project.work_mode || "未设置");
            const participantCount = escapeHtml(project.participant_count || "未设置");
            const projectId = Number(project.project_id) || 0;

            return `
                <div class="project-card">
                    <div class="project-header">
                        <h3 class="project-title">${projectName}</h3>
                        <div class="project-org"><i class="fas fa-building"></i> ${company}</div>
                        <div class="project-tags">
                            <span class="tag tag-status">${status}</span>
                        </div>
                    </div>
                    <div class="project-body">
                        <p class="project-description">${description}</p>
                        <div class="project-details">
                            <div class="detail-item">
                                <span class="detail-label">截止时间</span>
                                <span class="detail-value">${deadline}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">预计市场</span>
                                <span class="detail-value">${expectedMarket}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">工作方式</span>
                                <span class="detail-value">${workMode}</span>
                            </div>
                            <div class="detail-item">
                                <span class="detail-label">参与人数</span>
                                <span class="detail-value">${participantCount}</span>
                            </div>
                        </div>
                    </div>
                    <div class="project-footer">
                        <a href="project_detail.html?id=${projectId}" class="btn-detail">
                            <i class="fas fa-info-circle"></i> 查看详情
                        </a>
                    </div>
                </div>
            `;
        }).join("");
    }

    async function loadProjects() {
        const keyword = normalizeText(document.getElementById("keyword").value);
        const params = new URLSearchParams();
        if (keyword) params.set("q", keyword);

        try {
            const response = await fetch(`${API_BASE}/api/projects?${params.toString()}`);
            const data = await response.json();
            if (!response.ok || data.success === false) {
                throw new Error(data.message || "项目列表加载失败");
            }
            const projects = Array.isArray(data.projects) ? data.projects : [];
            renderProjects(applyFilters(projects));
        } catch (err) {
            document.getElementById("projects-container").innerHTML = `<div class="error">${escapeHtml(err.message)}</div>`;
            document.getElementById("total-projects").textContent = "0";
        }
    }

    function clearFilters() {
        document.getElementById("keyword").value = "";
        document.getElementById("status").value = "";
        document.getElementById("type").value = "";
        document.getElementById("difficulty").value = "";
        document.getElementById("mode").value = "";
        document.getElementById("sort").value = "newest";
        loadProjects();
    }

    function searchProjects() {
        loadProjects();
    }

    function renderMyApplications(apps) {
        const section = document.getElementById("my-apps-section");
        const container = document.getElementById("my-apps-container");
        if (!isStudentUser() || !token) {
            section.style.display = "none";
            return;
        }
        section.style.display = "block";
        if (!apps.length) {
            container.innerHTML = '<div class="empty">暂无申请记录</div>';
            return;
        }
        container.innerHTML = apps.map((app) => `
            <div class="project-card">
                <div class="project-header">
                    <h3 class="project-title">${escapeHtml(app.project_name || "-")}</h3>
                    <div class="project-org"><i class="fas fa-user-tag"></i> ${escapeHtml(app.role_name || "-")}</div>
                    <div class="project-tags">
                        <span class="tag tag-status">${escapeHtml(app.status || "-")}</span>
                    </div>
                </div>
                <div class="project-body">
                    <p class="project-description">${escapeHtml(app.motivation || "无申请说明")}</p>
                    <div class="project-details">
                        <div class="detail-item">
                            <span class="detail-label">申请时间</span>
                            <span class="detail-value">${escapeHtml(formatDate(app.apply_time))}</span>
                        </div>
                        <div class="detail-item">
                            <span class="detail-label">项目ID</span>
                            <span class="detail-value">${escapeHtml(String(app.project_id || "-"))}</span>
                        </div>
                    </div>
                </div>
            </div>
        `).join("");
    }

    async function loadMyApplications() {
        if (!isStudentUser() || !token) {
            renderMyApplications([]);
            return;
        }
        try {
            const response = await fetch(`${API_BASE}/api/student/applications`, {
                headers: { Authorization: `Bearer ${token}` }
            });
            const data = await response.json();
            if (!response.ok || data.success === false) {
                throw new Error(data.message || "申请列表加载失败");
            }
            const apps = Array.isArray(data.applications) ? data.applications : [];
            renderMyApplications(apps);
        } catch (_) {
            renderMyApplications([]);
        }
    }

    async function initCurrentUser() {
        const localName = localStorage.getItem("username");
        const localType = localStorage.getItem("user_type");
        setCurrentUserDisplay(localName, localType);

        if (!token) return;

        try {
            const response = await fetch(`${API_BASE}/api/auth/profile`, {
                headers: { Authorization: `Bearer ${token}` }
            });
            const data = await response.json();
            if (response.ok && data.success && data.user) {
                const name = data.user.username || "";
                const type = data.user.user_type || "";
                localStorage.setItem("username", name);
                localStorage.setItem("user_type", type);
                setCurrentUserDisplay(name, type);
                updateNavActionLink();
                loadMyApplications();
            }
        } catch (_) {
        }
    }

    updateNavActionLink();
    initCurrentUser();
    loadProjects();
    document.getElementById("my-apps-section").style.display = "none";
</script>
</body>
</html>
